# Claw-Empire v1.2.0 Release Notes

- Release date: 2026-02-25
- Scope: Department management tab, project-level manual agent assignment, meeting participant filtering for manual projects, mobile-responsive Project Manager, and bug fixes.

## Highlights

### Department Management Tab
- Added **subtab toggle** (`Agents | Departments`) inside Agent Manager.
- Department list view with sort order, icon, name, color, agent count, description, and ID.
- **Sort order editing** via arrow buttons with batch save.
- Backend: `PATCH /api/departments/reorder` endpoint using temporary high-value sort_order to avoid UNIQUE constraint conflicts during reorder.

### Project Manual Agent Assignment
- Projects now support `assignment_mode`: `auto` (default) or `manual`.
- In manual mode, specific agents can be assigned via multi-select checkbox UI with **sprite avatar icons** and department/role text labels.
- New DB schema: `assignment_mode` column on `projects` table + `project_agents` junction table.
- Backend CRUD: `POST /api/projects` and `PATCH /api/projects/:id` accept `assignment_mode` and `agent_ids`.
- `GET /api/projects` and `GET /api/projects/:id` return `assigned_agent_ids` per project.

### Meeting Participant Filtering (Manual Mode)
- When a project uses `assignment_mode: manual`, kickoff and review meetings only include:
  - **Planning team leader** (always included as meeting facilitator)
  - **Team leaders from departments of the assigned agents**
- The `fallbackAll` expansion (invite all active team leaders) is skipped for manual-mode projects.
- Applies to both kickoff (`startPlannedApprovalMeeting`) and review (`startReviewConsensusMeeting`) meetings.

### Task Delegation with Manual Mode
- `findBestSubordinate` in `collab.ts` now accepts optional `candidateAgentIds` parameter.
- When project is manual mode, `handleTaskDelegation` queries `project_agents` and restricts subordinate candidates to the assigned agent pool.
- Auto mode projects retain existing delegation logic unchanged.

### ChatPanel Manual Mode Indicator
- Project confirm step now displays assigned agent count for manual-mode projects (e.g., "Manual mode — 2 assigned agents will work on this").

### Mobile-Responsive Project Manager
- **List-detail toggle pattern** for mobile viewports (below `md` breakpoint / 768px):
  - Project list (aside) takes full width when no project is selected.
  - Selecting a project or creating new hides the list and shows the detail section.
  - Mobile-only `← List` back button to return to project list.
- Desktop layout remains unchanged (side-by-side panels).

### Bug Fixes
- **500 error on project save with agent_ids** — `runInTransaction` was not destructured from `__ctx` in `core.ts`, causing `ReferenceError`. Added `const runInTransaction = __ctx.runInTransaction`.
- **Unreadable error messages in light mode** — Changed `text-rose-200` (light pink on pink background) to `text-rose-800 dark:text-rose-200` for proper contrast in both themes. Same fix applied to success messages (`text-cyan-800 dark:text-cyan-100`).

## Changed Files

### Frontend
- `src/types/index.ts` — Added `AssignmentMode` type and extended `Project` interface
- `src/api.ts` — Added `reorderDepartments()`, extended project CRUD with assignment_mode/agent_ids
- `src/components/AgentManager.tsx` — Department management subtab with sort order editing
- `src/components/ProjectManagerModal.tsx` — Manual agent selection UI, sprite avatars, mobile responsive layout, error message contrast fix
- `src/components/TaskBoard.tsx` — Pass `departments` prop to ProjectManagerModal
- `src/components/ChatPanel.tsx` — Manual mode indicator in project confirm step

### Backend
- `server/server-main.ts` — DB migration (assignment_mode column + project_agents table)
- `server/modules/routes/core.ts` — Department reorder API, project CRUD with agent mapping, runInTransaction fix
- `server/modules/routes/collab.ts` — findBestSubordinate candidateAgentIds, handleTaskDelegation manual mode filtering
- `server/modules/workflow/orchestration/meetings.ts` — Meeting participant filtering for manual-mode projects

### Docs
- `README.md`
- `README_ko.md`
- `README_jp.md`
- `README_zh.md`
- `docs/releases/README.md`
- `docs/releases/v1.2.0.md`

## Verification

- `npx tsc --noEmit` — passed (zero errors)
- `npx vite build` — passed (built in ~6s)
